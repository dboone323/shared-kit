name: ü§ñ Copilot Code Review & Enhancement

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: read

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests openai anthropic

      - name: Run Copilot Code Review (GPT-5.3-Codex)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üîç Running Copilot Code Review with GPT-5.3-Codex..."
          python3 -c "
          import os
          import requests
          from openai import OpenAI
          from anthropic import Anthropic

          # Initialize AI clients
          openai_client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
          anthropic_client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

          pr_number = os.getenv('PR_NUMBER')
          if pr_number:
              print(f'Reviewing PR #{pr_number} with February 2026 Copilot models...')

              # Get PR details
              headers = {'Authorization': f'token {os.getenv(\"GITHUB_TOKEN\")}'}
              pr_url = f'https://api.github.com/repos/{os.getenv(\"GITHUB_OWNER\")}/{os.getenv(\"GITHUB_REPO\")}/pulls/{pr_number}'
              pr_response = requests.get(pr_url, headers=headers)
              pr_data = pr_response.json()

              # Get PR diff
              diff_url = f'{pr_url}/files'
              diff_response = requests.get(diff_url, headers=headers)
              files = diff_response.json()

              # Analyze with GPT-5.3-Codex
              analysis_prompt = f'Analyze this PR: {pr_data.get(\"title\", \"\")}\\n\\nChanges: {[f[\"filename\"] for f in files[:5]]}\\n\\nProvide a code review focusing on: 1) Code quality 2) Security 3) Performance 4) Best practices'

              try:
                  gpt_response = openai_client.chat.completions.create(
                      model='gpt-5.3-codex',
                      messages=[{'role': 'user', 'content': analysis_prompt}],
                      max_tokens=1000
                  )
                  gpt_review = gpt_response.choices[0].message.content
                  print('‚úÖ GPT-5.3-Codex analysis complete')
              except Exception as e:
                  print(f'‚ö†Ô∏è  GPT-5.3-Codex failed: {e}')
                  gpt_review = 'GPT analysis unavailable'

              # Analyze with Claude Opus 4.6
              try:
                  claude_response = anthropic_client.messages.create(
                      model='claude-opus-4.6',
                      max_tokens=1000,
                      messages=[{'role': 'user', 'content': analysis_prompt}]
                  )
                  claude_review = claude_response.content[0].text
                  print('‚úÖ Claude Opus 4.6 analysis complete')
              except Exception as e:
                  print(f'‚ö†Ô∏è  Claude Opus 4.6 failed: {e}')
                  claude_review = 'Claude analysis unavailable'

              # Post combined review
              review_body = f'''## ü§ñ Copilot Code Review (February 2026 Models)

### GPT-5.3-Codex Analysis
{gpt_review}

### Claude Opus 4.6 Analysis
{claude_review}

### Recommendations
- Review the AI suggestions above
- Consider implementing automated fixes where applicable
- Ensure all security concerns are addressed

*Generated by GitHub Copilot with February 2026 models*
'''

              # Post the review comment
              review_url = f'https://api.github.com/repos/{os.getenv(\"GITHUB_OWNER\")}/{os.getenv(\"GITHUB_REPO\")}/issues/{pr_number}/comments'
              requests.post(review_url, headers=headers, json={'body': review_body})

              print('‚úÖ Copilot review posted to PR')
          else:
              print('‚ÑπÔ∏è  No PR number - skipping review')
          "

      - name: Run Copilot Autofix (Security)
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üîß Running Copilot Autofix for security issues..."
          python3 -c "
          import os
          import requests
          from openai import OpenAI

          openai_client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
          pr_number = os.getenv('PR_NUMBER')

          if pr_number:
              headers = {'Authorization': f'token {os.getenv(\"GITHUB_TOKEN\")}'}

              # Check for security alerts
              alerts_url = f'https://api.github.com/repos/{os.getenv(\"GITHUB_OWNER\")}/{os.getenv(\"GITHUB_REPO\")}/dependabot/alerts'
              alerts_response = requests.get(alerts_url, headers=headers)

              if alerts_response.status_code == 200:
                  alerts = alerts_response.json()
                  if alerts:
                      print(f'üö® Found {len(alerts)} security alerts')

                      # Generate autofix suggestions
                      for alert in alerts[:3]:  # Limit to first 3 alerts
                          fix_prompt = f'Generate a fix for this security vulnerability: {alert.get(\"security_advisory\", {}).get(\"summary\", \"\")}\\nPackage: {alert.get(\"dependency\", {}).get(\"package\", {}).get(\"name\", \"\")}\\nCurrent version: {alert.get(\"dependency\", {}).get(\"manifest_path\", \"\")}'

                          try:
                              fix_response = openai_client.chat.completions.create(
                                  model='gpt-5.3-codex',
                                  messages=[{'role': 'user', 'content': fix_prompt}],
                                  max_tokens=500
                              )
                              fix_suggestion = fix_response.choices[0].message.content

                              # Post fix suggestion as comment
                              comment_url = f'https://api.github.com/repos/{os.getenv(\"GITHUB_OWNER\")}/{os.getenv(\"GITHUB_REPO\")}/issues/{pr_number}/comments'
                              comment_body = f'''## üîß Copilot Autofix Suggestion

**Security Issue:** {alert.get('security_advisory', {}).get('summary', '')}

**Suggested Fix:**
{fix_suggestion}

*Generated by Copilot Autofix (GPT-5.3-Codex)*
'''
                              requests.post(comment_url, headers=headers, json={'body': comment_body})
                              print('‚úÖ Autofix suggestion posted')
                          except Exception as e:
                              print(f'‚ö†Ô∏è  Autofix failed: {e}')
                  else:
                      print('‚úÖ No security alerts found')
              else:
                  print('‚ö†Ô∏è  Could not check security alerts')
          "
