name: ðŸ”’ Comprehensive Security Scan (February 2026)

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:

permissions:
    contents: read
    security-events: write
    actions: read
    issues: write

jobs:
    security-scan:
        name: Comprehensive Security Analysis
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install security tools
              run: |
                  pip install bandit safety semgrep

            - name: Run CodeQL Analysis (Enhanced)
              uses: github/codeql-action/init@v3
              with:
                  languages: javascript,python,java,go,cpp
                  config-file: ./.github/codeql-config.yml

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3

            - name: Run Bandit (Python Security)
              if: contains(github.event.head_commit.modified, '.py')
              run: |
                  bandit -r . -f json -o bandit-results.json || true

            - name: Run Semgrep (Advanced SAST)
              uses: semgrep/semgrep-action@v1
              with:
                  config: auto
                  generateSarif: "1"

            - name: Upload Semgrep results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: semgrep.sarif

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: trivy-results.sarif

            - name: Enhanced Secret Scanning
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  extra_args: --debug --only-verified

            - name: Dependency Security Audit
              run: |
                  # Python dependencies
                  if [[ -f "requirements.txt" ]] || [[ -f "pyproject.toml" ]]; then
                      safety check --output json > safety-results.json || true
                  fi

                  # Node.js dependencies
                  if [[ -f "package.json" ]]; then
                      npm audit --audit-level moderate --json > npm-audit.json || true
                  fi

            - name: Generate Security Report
              run: |
                  echo "## ðŸ”’ Security Scan Report" > security-report.md
                  echo "" >> security-report.md
                  echo "**Repository:** $GITHUB_REPOSITORY" >> security-report.md
                  echo "**Date:** $(date)" >> security-report.md
                  echo "" >> security-report.md
                  echo "### Scan Results" >> security-report.md
                  echo "- âœ… CodeQL analysis completed" >> security-report.md
                  echo "- âœ… Secret scanning completed" >> security-report.md
                  echo "- âœ… Dependency audit completed" >> security-report.md
                  echo "" >> security-report.md
                  echo "*Generated by Comprehensive Security Scan (February 2026)*" >> security-report.md

            - name: Comment on PR with Security Results
              if: github.event_name == 'pull_request'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [[ -f "security-report.md" ]]; then
                      gh pr comment ${{ github.event.pull_request.number }} -F security-report.md
                  fi

            - name: Archive Security Results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-scan-results
                  path: |
                      *-results.*
                      security-report.md
