name: Split Platform Release

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      release_channel:
        description: Release channel
        required: true
        default: candidate
        type: choice
        options:
          - candidate
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  linux_docker_build:
    name: Linux Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Linux image
        env:
          IMAGE_TAG: ghcr.io/${{ github.repository }}:${{ github.sha }}
        run: |
          set -euo pipefail
          docker buildx build \
            --file Dockerfile \
            --pull \
            --load \
            --sbom=false \
            --provenance=false \
            --tag "${IMAGE_TAG}" \
            .
          docker image inspect "${IMAGE_TAG}" > linux-image-metadata.json

      - name: Validate compose
        run: |
          set -euo pipefail
          docker compose -f docker-compose.yml config > /tmp/compose.out
          tail -n 40 /tmp/compose.out || true

      - name: Upload Linux build metadata
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-metadata
          path: linux-image-metadata.json
          retention-days: 14

  apple_package_ci:
    name: Apple Swift Package Build/Test
    runs-on: macos-26
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve package dependencies
        run: swift package resolve

      - name: Build package
        run: swift build -c release

      - name: Run tests
        run: swift test --enable-code-coverage

      - name: Capture coverage summary
        run: |
          set -euo pipefail
          if [ -d .build ]; then
            find .build -maxdepth 4 -type f | head -n 100 > build-file-index.txt
          else
            echo "No .build directory found" > build-file-index.txt
          fi

      - name: Upload package build index
        uses: actions/upload-artifact@v4
        with:
          name: package-build-index
          path: build-file-index.txt
          retention-days: 14

  unified_release_gate:
    name: Unified Release Gate
    runs-on: ubuntu-latest
    needs: [linux_docker_build, apple_package_ci]
    if: always()
    steps:
      - name: Evaluate gate
        run: |
          set -euo pipefail
          echo "linux_docker_build=${{ needs.linux_docker_build.result }}"
          echo "apple_package_ci=${{ needs.apple_package_ci.result }}"
          if [ "${{ needs.linux_docker_build.result }}" != "success" ] || [ "${{ needs.apple_package_ci.result }}" != "success" ]; then
            echo "Unified gate failed"
            exit 1
          fi
          echo "Unified gate passed"

  release_manifest:
    name: Release Manifest
    runs-on: ubuntu-latest
    needs: [unified_release_gate]
    if: needs.unified_release_gate.result == 'success' && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch')
    steps:
      - name: Generate manifest
        run: |
          set -euo pipefail
          cat > release-manifest.json <<JSON
          {
            "repository": "${{ github.repository }}",
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "run_id": "${{ github.run_id }}",
            "linux_docker_build": "${{ needs.linux_docker_build.result }}",
            "apple_package_ci": "${{ needs.apple_package_ci.result }}",
            "generated_at_utc": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          JSON
          cat release-manifest.json

      - name: Upload release manifest
        uses: actions/upload-artifact@v4
        with:
          name: release-manifest
          path: release-manifest.json
          retention-days: 30
